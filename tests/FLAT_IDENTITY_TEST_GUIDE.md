# Flat Identity Model Test Guide

## Overview

This document describes the comprehensive test suite for the flat identity model implementation in Interspace. The flat identity model is a flexible authentication system that treats all authentication methods (wallet, email, social, guest, passkey) as equal "accounts" that can be linked together.

## Test Structure

### 1. Integration Tests

#### `tests/integration/flatIdentityModel.integration.test.js`
Comprehensive integration tests covering all authentication flows and scenarios:

- **New User Authentication Flow**
  - Wallet authentication with SIWE
  - Email authentication with verification codes
  - Social authentication (Google, Apple)
  - Guest authentication
  - Passkey registration
  
- **Existing User Authentication**
  - Return existing profiles
  - Handle multiple profiles
  - Session restoration
  
- **Account Linking/Unlinking**
  - Link wallet to email account
  - Link social accounts
  - Respect privacy modes
  - Prevent duplicate links
  - Unlink accounts safely
  
- **SmartProfile Management**
  - Create additional profiles
  - Switch between profiles
  - MPC wallet webhook updates
  - Profile deletion with cascades
  
- **Privacy Modes & Identity Graph**
  - Linked mode (full visibility)
  - Partial mode (limited data)
  - Isolated mode (no cross-visibility)
  - Identity graph traversal
  
- **Edge Cases & Security**
  - Concurrent authentication attempts
  - Account takeover prevention
  - Session expiration

### 2. Unit Tests

#### `tests/unit/services/accountService.test.js`
Core account service functionality:
- Account creation and retrieval
- Identity link management
- Profile access control
- Session management

#### `tests/unit/services/accountServiceExtended.test.js`
Advanced scenarios and edge cases:
- Passkey account handling
- Transitive identity links
- Complex privacy mode scenarios
- Metadata management
- Profile-account linking

## Key Test Scenarios

### 1. New User First Authentication

When a new user authenticates for the first time:

```javascript
// Test flow:
1. User authenticates (wallet/email/social)
2. Account is created
3. Automatic "My Smartprofile" is created
4. Session wallet placeholder is generated
5. Profile is linked to account
6. Session is created with privacy mode
7. JWT tokens are generated
```

### 2. MPC Wallet Generation Flow

The two-phase wallet creation process:

```javascript
// Phase 1: Profile creation
1. Profile created with placeholder wallet address
2. User can start using the app immediately

// Phase 2: MPC key generation (async via webhook)
1. MPC keys generated by duo-node
2. Webhook updates profile with actual wallet address
3. Orby cluster is updated
```

### 3. Account Linking Flow

Linking multiple authentication methods:

```javascript
1. User authenticates with primary account
2. User initiates link with secondary account
3. Secondary account ownership is verified
4. Identity link is created with privacy mode
5. Secondary account gains access to profiles
```

### 4. Privacy Mode Enforcement

Privacy modes control data visibility:

- **Linked**: Full visibility and data sharing
- **Partial**: Limited data sharing, some restrictions
- **Isolated**: No visibility between accounts

## Running the Tests

### Run All Flat Identity Tests
```bash
npm run test:flat-identity
# or
./scripts/test-flat-identity.sh
```

### Run Specific Test Suite
```bash
# Integration tests
npm test tests/integration/flatIdentityModel.integration.test.js

# Unit tests
npm test tests/unit/services/accountService.test.js
npm test tests/unit/services/accountServiceExtended.test.js
```

### Run with Coverage
```bash
npm test -- --coverage tests/integration/flatIdentityModel.integration.test.js
```

## Test Data Setup

Tests use a clean database for each test case:

```javascript
async function cleanDatabase() {
  // Clean in correct order due to foreign keys
  await prisma.auditLog.deleteMany();
  await prisma.emailVerification.deleteMany();
  await prisma.accountSession.deleteMany();
  await prisma.profileAccount.deleteMany();
  await prisma.identityLink.deleteMany();
  // ... other tables
}
```

## Mocking Strategy

### External Services
- **SIWE**: Mock signature verification
- **Google OAuth**: Mock token verification
- **Apple Sign In**: Mock token verification
- **Session Wallet Service**: Mock wallet creation
- **MPC Service**: Mock key generation

### Example Mock
```javascript
jest.spyOn(siweService, 'verifyMessage').mockResolvedValueOnce({
  valid: true,
  address: walletAddress
});
```

## Common Test Patterns

### 1. Authentication Test
```javascript
const response = await request(server)
  .post('/api/v2/auth/authenticate')
  .send({
    strategy: 'wallet',
    walletAddress,
    signature,
    message
  })
  .expect(200);

expect(response.body).toMatchObject({
  success: true,
  account: { /* ... */ },
  profiles: [ /* ... */ ],
  isNewUser: true
});
```

### 2. Database Verification
```javascript
const account = await prisma.account.findUnique({
  where: {
    type_identifier: {
      type: 'wallet',
      identifier: walletAddress.toLowerCase()
    }
  }
});
expect(account).toBeTruthy();
expect(account.verified).toBe(true);
```

### 3. Identity Link Verification
```javascript
const link = await prisma.identityLink.findFirst({
  where: {
    OR: [
      { accountAId: account1.id, accountBId: account2.id },
      { accountAId: account2.id, accountBId: account1.id }
    ]
  }
});
expect(link.privacyMode).toBe('linked');
```

## Debugging Tips

1. **Enable Prisma Query Logging**
   ```javascript
   const prisma = new PrismaClient({
     log: ['query', 'error', 'warn']
   });
   ```

2. **Use Console Logs in Tests**
   ```javascript
   console.log('Account created:', JSON.stringify(account, null, 2));
   ```

3. **Check Test Database State**
   ```bash
   # Connect to test database
   npx prisma studio
   ```

4. **Run Single Test**
   ```javascript
   it.only('should test specific scenario', async () => {
     // Test code
   });
   ```

## Future Test Additions

1. **Performance Tests**
   - Load testing for concurrent authentications
   - Identity graph traversal performance

2. **Security Tests**
   - Penetration testing scenarios
   - Token expiration edge cases

3. **Integration with External Services**
   - Real MPC key generation tests
   - Orby cluster integration tests

4. **Mobile-Specific Tests**
   - iOS/Android authentication flows
   - Biometric authentication